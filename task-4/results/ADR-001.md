# ADR-001: Разработка ETL пайплайна

**Статус:** ⚠️ На рассмотрении

**Участники:** Кондрашов М.В.

**Дата:** 2025-10-06

---

## 1. Контекст

В текущий момент данные в систему обновления остатков данные поступают в виде файлов. Отсутствие пакетной обработки приводит к необходимости обрабатывать каждую запись отдельно в «онлайн-режиме», что негативно сказывается на производительности всей системы:

- Обновления остатков в БД идут построчно, что перегружает транзакционные ресурсы.
- Отчётность формируется в реальном времени, хотя её можно унести в ночную пакетную обработку.
- API для взаимодействия с логистическими партнёрами и региональными складами страдают от задержек и взаимного блокирования, когда один поток данных тормозит все остальные.
- В случае ошибок трудно отследить причину её возникновения и свести имеющиеся логи и метрики в одну картину.

В ближайшее время TradeWare планирует запустить масштабную рекламную кампанию, чтобы привлечь новых партнёров и клиентов. Поэтому компания ждёт значительный рост числа пользователей, заявок на хранение, а также объёмов данных по движениям и остаткам товаров на складах. Помимо этого TradeWare сбирается расширить номенклатуру товаров и интеграцию с другими источниками данных, что потребует гибких способов проектирования пайплайна данных и retry-механизмы в них.

На текущий момент требуется разработка POC решения.

---

## 2. Требования

### Функциональные

| Категория       | Требование                  |
|-----------------|-----------------------------|
| **F**unctional  | Реализация пайплана по загрузке данных из CSV в БД с валидацией и преобразованием |

### Нефункциональные

| Категория       | Требование                  |
|-----------------|-----------------------------|
| **R**eliability   | Автоматическое восстановление при ошибках, сохранение целостности данных |
| **P**erformance | Среднее время обработки отчета на 2 000 строк должно составлять до 30 секунд. Предполагаемая нагрузка — 100-150 параллельных загрузок в пиковые часы. Также нужна возможность гибко масштабироваться под нагрузкой. |
| **S**upportability | Внедрение системы централизованного сбора логов и метрик |

---

## 3. Решение

### Описание

Реализовать отдельный сервис с использованием Spring Batch для реализации ETL пайплайна. Диаграмма архитектуры системы с внедренным новым компонентом:

```plantuml
@startuml C4_Container
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(employee, "Сотрудник склада")
System_Boundary(backend, "Backend") {
  Container(frontend, "Web UI", "JS, Angular", "Приложение для пользователя, Web-интерфейс")
  Container(monolith, "Монолит", "Java 11 / WildFly", "Логика обработки отчетов")
  ContainerDb(result_db, "БД номенклатуры", "PostgreSQL", "Актуальные данные о наличии товаров на складе")
  ContainerDb(goods_db, "БД номенклатуры", "PostgreSQL", "Данные о характеристиках товаров, промо-акции и т.д.")
  ContainerDb(gcs, "Файловое хранилище", "Google Cloud Storage", "CSV файлы")
  Container(etl, "ETL сервис", "Spring Batch", "Чтение CSV файлов и заполнение таблиц результатов, формирование отчетов")
}

System(obs, "Observability", "Prometheus, Grafana, ELK, OTel", "Метрики/Логи/Трейсы")

Rel(employee, frontend, "Использует")
Rel(frontend, monolith, "Отправляет запросы", "HTTP")
Rel(monolith, gcs, "Загрузка файлов")
Rel(monolith, etl, "Запуск пайплайна")

Rel(etl, gcs, "Чтение CSV")
Rel(etl, goods_db, "Чтение дополнительных данных о товарах")
Rel(etl, result_db, "Запись результатов")
Rel(etl, obs, "Метрики, логи, трейсы")

@enduml
```

### Обоснование

Фреймворк предоставляет инструменты для работы с файлами и БД, готовые инструменты как Step, Chunk, Retry и т.д., которые помогут удовлетворить требованиям по надежности и повторным обработкам.

Масштабируемость будет достигаться через partitioning/remote-chunking/parallel steps. Логи, метрики и трасировка также проще реализовать с использованием готовых инструментов, например Spring Boot Actuator.

Кроме того, немаловажно, что команда уже имеет опыт работы

---

### 4. Альтернативы

| Вариант | Плюсы | Минусы | Почему отклонен |
|---|---|---|---|
| Apache Airflow | реализация пайплайна через DAG, удобный интерфейс, множество готовых интеграция | Потребует Python стэка и дополнительного обучения | Так как задача не столь комплексная, на данный момент Airflow избыточен |
| Kubernetes CronJob + приложение на Java для обработки | Простая реализация, легко покрывающая требования | Kubernetes не указан нигде в стэке, и если его нет, поднимать ради одного job'а его точно не стоит | Предположительно, Kubernetes в компании не используется |

---
